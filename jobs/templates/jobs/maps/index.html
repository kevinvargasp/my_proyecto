{% extends 'layout/admin_base.html' %}
{% load utils %}
{% block title_layout %}
    <h3>Trabajos</h3>
{% endblock %}
{% block layout %}

    <div class="panel panel-primary">
        <div class="row">
            <div class="col-md-8">
                <div id="gmap" style="width: 100%; height: 450px"></div>
            </div>
            <div class="col-md-4">
                <h3>Filtros</h3>
                <div class="btn btn-success btn-block">Todos</div>
                <div class="btn btn-success btn-block">Asignados</div>
                <div class="btn btn-success btn-block">Sin Asignar</div>
                <div class="btn btn-success btn-block">Realizados</div>
            </div>
        </div>
        <div class="row">
            <div class="form-inline padding-bottom-15">
                <div class="row">
                    <div class="col-sm-6">
                        <div class="form-group">

                        </div>
                    </div>
                    <div class="col-sm-6 text-right m-b-20">
                        <div class="form-group">
                            <input id="demo-input-search2" type="text" placeholder="Buscar"
                                   class="form-control"
                                   autocomplete="off">
                        </div>
                    </div>
                </div>
            </div>
            <table id="table-users" class="table table-bordered table-striped">
                <thead class="table-bordered ">
                <tr>
                    <th>#</th>
                    <th>{% get_field_name job_obj 'jobtype' %}</th>
                    <th>Estado de asignacion</th>
                    <th>{% get_field_name job_obj 'state' %}</th>
                    <th>{% get_field_name job_obj 'register_at' %}</th>
                    <th>{% get_field_name job_obj 'name_client' %}</th>
                    <th>{% get_field_name job_obj 'description' %}</th>
                </tr>
                </thead>

                <tbody>
                {% for job in jobs %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>{{ job.jobtype }}</td>
                        <td class="text-center">{% autoescape off %}
                            {% is_assigned job.id %}
                        {% endautoescape %}
                        </td>
                        <td>{{ job.state }}</td>
                        <td>{{ job.register_at }}</td>
                        <td>{{ job.name_client }}</td>
                        <td>{{ job.description }}</td>
                    </tr>
                {% endfor %}
                </tbody>
                <tfoot>
                <tr>
                    <td colspan="7">
                        <div class="text-right">
                            <ul class="pagination">
                            </ul>
                        </div>
                    </td>
                </tr>
                </tfoot>
            </table>
        </div>
    </div>
{% endblock %}
{% block code_js %}
    {% include 'partials/_url_gmaps.html' %}

    <script>
        $(document).ready(function () {
            // Search input
            $('#demo-input-search2').on('input', function (e) {
                e.preventDefault();
                addrow.trigger('footable_filter', {filter: $(this).val()});
            });
            var addrow = $('#table-users');
            addrow.footable().on('click', '.delete-row-btn', function () {

                //get the footable object
                var footable = addrow.data('footable');

                //get the row we are wanting to delete
                var row = $(this).parents('tr:first');

                //delete the row
                footable.removeRow(row);
            });
        })


        var beaches = [];

        {% for point in jobs %}
            var new_point = [];

            new_point.push("<b>Cliente:</b> {{ point.name_client }}<br><b>Estado:</b> {{ point.state }}<br><b>Descripci√≥n:</b> {{ point.description }} <br><b>Asignado a:</b> {{ point.profile }}");
            new_point.push({{ point.lat }});
            new_point.push({{ point.lng }});

            beaches.push(new_point);

        {% endfor %}



        var MY_MAPTYPE_ID = 'custom_style';
        var directionsDisplay;
        var directionsService = new google.maps.DirectionsService();
        var map;

        function initialize() {
            directionsDisplay = new google.maps.DirectionsRenderer({
                suppressMarkers: true
            });

            if (jQuery('#gmap').length > 0) {


                map = new google.maps.Map(document.getElementById('gmap'), {});
                directionsDisplay.setMap(map);

                var infowindow = new google.maps.InfoWindow();
                var flightPlanCoordinates = [];
                var bounds = new google.maps.LatLngBounds();

                for (i = 0; i < beaches.length; i++) {
                    marker = new google.maps.Marker({
                        position: new google.maps.LatLng(beaches[i][1], beaches[i][2]),
                        map: map,
                        animation: google.maps.Animation.DROP,
                        id: beaches[i][0],
                        color: "green",
                    });
                    flightPlanCoordinates.push(marker.getPosition());
                    bounds.extend(marker.position);

                    google.maps.event.addListener(marker, 'click', (function (marker, i) {
                        return function () {
                            infowindow.setContent(beaches[i][0]);
                            infowindow.open(map, marker);
                        }
                    })(marker, i));
                }

                map.fitBounds(bounds);

                // directions service configuration
                var start = flightPlanCoordinates[0];
                var end = flightPlanCoordinates[flightPlanCoordinates.length - 1];
                var waypts = [];
                for (var i = 1; i < flightPlanCoordinates.length - 1; i++) {
                    waypts.push({
                        location: flightPlanCoordinates[i]
                    });
                }
            }
        }

        function moveMarker(lat, lng) {
            var latlng = new google.maps.LatLng(parseFloat(lat), parseFloat(lng));
            map.setCenter(latlng);
        }


        google.maps.event.addDomListener(window, 'load', initialize);
    </script>
{% endblock %}